# Утилита очистки кэша 1С:Предприятие (v5.2)

## Назначение
PowerShell-скрипт для удаления кэш-данных 1С на локальных и удаленных компьютерах в рамках сети. Решает проблемы с поврежденным кэшем, вызывающим ошибки при запуске 1С. Поддерживает гибкие сценарии использования от единичных компьютеров до массовой очистки в корпоративной среде.

## Основные возможности
- **Универсальная очистка**: Работа на локальном и удаленных компьютерах
- **Три метода доступа**: Автоматический выбор оптимального способа (админ-шара, WMI, PS Remoting)
- **Интеллектуальная проверка**: Обнаружение запущенных процессов 1С перед очисткой
- **Гибкие режимы**: Интерактивное меню и автоматический режим для пакетной обработки
- **Детальное логирование**: Ротация логов, запись в Windows Event Log
- **Безопасность**: Сохранение системных профилей, защита от случайного удаления

## Требования
- **ОС**: Windows 7/8/10/11, Windows Server 2008 R2+
- **PowerShell**: Версия 5.1+ (рекомендуется)
- **Права**: Локальный администратор
- **Для удаленной очистки**:
  - Сетевой доступ к целевым компьютерам
  - Доступ хотя бы к одному методу: WMI (порт 135), админ-шара (C$), PS Remoting

## Инструкция по использованию

### Базовый запуск
```powershell
powershell.exe -ExecutionPolicy Bypass -File "clear_1C_cash.ps1"
```
(или создать ярлык с параметрами: `C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -File "\\путь_к_скрипту\clear_1C_cash.ps1"`)

### Параметры запуска
| Параметр       | Описание                                  | Пример использования                        |
|----------------|-------------------------------------------|---------------------------------------------|
| `-ComputerName`| Очистка на удаленном компьютере           | `.\clear_1C_cash.ps1 -ComputerName WS-025` |
| `-AutoMode`    | Автоматический режим (без меню)           | `.\clear_1C_cash.ps1 -AutoMode`            |
| `-Force`       | Принудительная очистка                    | `.\clear_1C_cash.ps1 -Force`               |
| `-LogPath`     | Кастомный путь для логов                  | `.\clear_1C_cash.ps1 -LogPath "C:\logs\1c_clean.log"` |

### Примеры использования
```powershell
# Локальная очистка с интерактивным меню
.\clear_1C_cash.ps1

# Удаленная очистка в автоматическом режиме
.\clear_1C_cash.ps1 -ComputerName SRV-1C-01 -AutoMode

# Принудительная очистка (игнорируя запущенные процессы 1С)
.\clear_1C_cash.ps1 -Force

# Массовая очистка списка компьютеров
"WS-011", "WS-012", "SRV-ACCOUNTING" | ForEach-Object {
    .\clear_1C_cash.ps1 -ComputerName $_ -AutoMode
}
```

## Технические детали
### Очищаемые каталоги
```
%LOCALAPPDATA%\1C\1Cv8
%APPDATA%\1C\1Cv8
```

### Критерии удаления
Папки с именами в формате GUID (пример: `c0a895a1-7f8b-4d5e-9c3f-6a1b9c8d0e7f`)

### Приоритет методов
1. Административная шара (`\\comp\c$\Users`)
2. WMI (Win32_UserProfile)
3. PowerShell Remoting (WinRM)

### Логирование
- Путь по умолчанию: `%TEMP%\clear_1c_cache.log`
- Автоматическая ротация при достижении 1 МБ
- Успешные операции фиксируются в Event Log (Источник: 1CCacheCleaner)

## Важные примечания
1. Для работы через PowerShell Remoting должна быть включена соответствующая конфигурация:
   ```powershell
   Enable-PSRemoting -Force
   Set-NetFirewallRule -Name "WINRM-HTTP-In-TCP" -RemoteAddress Any
   ```
2. Перед массовой очисткой проверьте доступность методов:
   ```powershell
   .\clear_1C_cash.ps1 -ComputerName TEST-PC -AutoMode
   ```
3. При очистке на работающих сеансах 1С возможны сбои в работе приложений. Скрипт не чистит занятые файлы
  
4. Скрипт не затрагивает:
   - Системные профили (`systemprofile`, `service`)
   - Активные пользовательские сессии
   - Не-GUID директории в кэше 1С

## Поддержка
Для отчетов об ошибках или предложений по улучшению создавайте Issues в репозитории проекта.
Copyright © 2025 Кодельник Максим Сергеевич | MIT License  
Версия: 5.2 (2025-07-24)
